<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: blob: ws: wss: https:;">
  <style>
    body { margin: 0; font-family: sans-serif; text-align: center; background: #f0f0f0; }
    video { width: 45%; margin: 10px; border-radius: 8px; background: black; }
    #status { margin: 10px; font-weight: bold; }
    button { padding: 8px 20px; margin: 10px; }
  </style>
</head>
<body>
  <h2>ðŸ“ž Appel WebRTC</h2>
  <div id="status">En attente...</div>
  <video id="localVideo" autoplay muted></video>
  <video id="remoteVideo" autoplay></video>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <script>
    const room = prompt("Nom de la salle ?");
    const socket = io();
    const status = document.getElementById("status");
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    let peer = null;

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      localVideo.srcObject = stream;
      peer = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      stream.getTracks().forEach(track => peer.addTrack(track, stream));

      peer.ontrack = e => { remoteVideo.srcObject = e.streams[0]; };
      peer.onicecandidate = e => {
        if (e.candidate) socket.emit("ice-candidate", room, e.candidate);
      };

      socket.emit("join", room);

      socket.on("ready", async () => {
        const offer = await peer.createOffer();
        await peer.setLocalDescription(offer);
        socket.emit("offer", room, offer);
      });

      socket.on("offer", async offer => {
        await peer.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peer.createAnswer();
        await peer.setLocalDescription(answer);
        socket.emit("answer", room, answer);
      });

      socket.on("answer", async answer => {
        await peer.setRemoteDescription(new RTCSessionDescription(answer));
      });

      socket.on("ice-candidate", candidate => {
        peer.addIceCandidate(new RTCIceCandidate(candidate));
      });

      status.textContent = "ConnectÃ© Ã  la salle : " + room;
    }).catch(err => {
      alert("Erreur camÃ©ra/micro : " + err);
    });
  </script>
</body>
</html>
